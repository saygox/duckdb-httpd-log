# name: test/sql/read_httpd_log.test
# description: test read_httpd_log table function with format_type parameter
# group: [sql]

require httpd_log

# Test 1: Basic usage without format_type parameter (should default to 'common')
# Note: Default raw=false, so parse_error and raw_line columns are not included
query TTTTIII
SELECT
    client_ip,
    ident,
    auth_user,
    timestamp,
    status,
    bytes,
    log_file
FROM read_httpd_log('test/data/common/sample.log')
ORDER BY timestamp
LIMIT 3;
----
192.168.1.1	NULL	frank	2000-10-10 20:55:36	200	2326	test/data/common/sample.log
192.168.1.2	NULL	alice	2000-10-10 20:56:45	201	150	test/data/common/sample.log
192.168.1.3	NULL	NULL	2000-10-10 20:57:12	304	0	test/data/common/sample.log

# Test 2: Verify schema without raw mode (11 columns: no parse_error, raw_line)
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
);
----
11

# Test 3: Verify schema with raw mode (13 columns: includes parse_error, raw_line)
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
);
----
13

# Test 4: Verify raw=false skips parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log');
----
3

# Test 5: Verify raw=true includes parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', raw=true);
----
5

# Test 6: Test with error lines - raw=true shows parse_error column
query II
SELECT
    parse_error,
    COUNT(*) as count
FROM read_httpd_log('test/data/common/with_errors.log', raw=true)
GROUP BY parse_error
ORDER BY parse_error;
----
0	3
1	2

# Test 7: Verify parse_error column does not exist with raw=false
statement error
SELECT parse_error FROM read_httpd_log('test/data/common/with_errors.log');
----
Binder Error: Referenced column "parse_error" not found in FROM clause

# Test 8: Verify raw_line is populated for parse errors with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', raw=true)
WHERE parse_error = true AND raw_line IS NOT NULL AND LENGTH(raw_line) > 0;
----
2

# Test 9: Verify raw_line column does not exist with raw=false
statement error
SELECT raw_line FROM read_httpd_log('test/data/common/with_errors.log');
----
Binder Error: Referenced column "raw_line" not found in FROM clause

# Test 10: Verify all 13 columns are returned with raw=true
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        method,
        path,
        query_string,
        protocol,
        status,
        bytes,
        log_file,
        parse_error,
        raw_line
    FROM read_httpd_log('test/data/common/sample.log', raw=true)
);
----
6

# Test 11: Test HTTP method extraction with raw=false (no WHERE needed)
query TI
SELECT method, COUNT(*) as count
FROM read_httpd_log('test/data/common/sample.log')
GROUP BY method
ORDER BY method;
----
GET	5
POST	1

# Test 12: Test status codes with raw=false (auto-skips errors)
query II
SELECT status, COUNT(*) as count
FROM read_httpd_log('test/data/common/sample.log')
GROUP BY status
ORDER BY status;
----
200	2
201	1
304	1
403	1
404	1

# Test 13: Test path extraction with raw=false
query TI
SELECT path, COUNT(*) as count
FROM read_httpd_log('test/data/common/sample.log')
WHERE path LIKE '/index%'
GROUP BY path;
----
/index.html	1

# Test 14: Error - invalid file path
statement error
SELECT * FROM read_httpd_log('nonexistent.log');
----
IO Error: No files found that match the pattern "nonexistent.log"

# Test 15: Error - too many arguments (named parameters don't support positional)
statement error
SELECT * FROM read_httpd_log('test/data/common/sample.log', 'common', 'extra');
----
Binder Error: No function matches the given name and argument types

# Test 16: Test with glob pattern
query I
SELECT COUNT(DISTINCT log_file)
FROM read_httpd_log('test/data/multi_file/server*.log');
----
3

# Test 17: Test bytes field with raw=false
query I
SELECT SUM(bytes)
FROM read_httpd_log('test/data/common/sample.log');
----
9900

# Test 18: Count total records across common format files (raw=false skips errors)
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/*.log');
----
9

# Test 19: Count total records with raw=true (includes errors)
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/*.log', raw=true);
----
11

# Test 20: Verify column names with raw=false (should be 11 columns)
query TTTTTTTTTTT
SELECT
    client_ip,
    ident,
    auth_user,
    timestamp,
    method,
    path,
    query_string,
    protocol,
    status,
    bytes,
    log_file
FROM read_httpd_log('test/data/common/sample.log')
LIMIT 1;
----
192.168.1.1	NULL	frank	2000-10-10 20:55:36	GET	/index.html	NULL	HTTP/1.0	200	2326	test/data/common/sample.log

# Test 21: Verify column names with raw=true (should be 13 columns)
query TTTTTTTTTTITT
SELECT
    client_ip,
    ident,
    auth_user,
    timestamp,
    method,
    path,
    query_string,
    protocol,
    status,
    bytes,
    log_file,
    parse_error,
    raw_line
FROM read_httpd_log('test/data/common/sample.log', raw=true)
LIMIT 1;
----
192.168.1.1	NULL	frank	2000-10-10 20:55:36	GET	/index.html	NULL	HTTP/1.0	200	2326	test/data/common/sample.log	0	192.168.1.1 - frank [10/Oct/2000:13:55:36 -0700] "GET /index.html HTTP/1.0" 200 2326

# Test 22: Verify raw_line is populated for successful parses with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false AND raw_line IS NOT NULL;
----
6

# Test 23: Verify both raw=true and format_type work together
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true);
----
6

# Test 24: Verify error message when trying to access diagnostic columns without raw=true
statement error
SELECT parse_error, raw_line FROM read_httpd_log('test/data/common/sample.log');
----
Binder Error: Referenced column "parse_error" not found in FROM clause
