# name: test/sql/compression/gzip_files.test
# description: Tests for reading gzip compressed log files
# group: [compression]

require httpd_log

# =============================================================================
# Test Group 1: Single gzip file
# =============================================================================

# Test 1: Read single gzip file - row count
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/compressed/access.log.gz', format_type='common');
----
6

# Test 2: Verify data is correctly parsed from gzip file
query II
SELECT status, COUNT(*) as count
FROM read_httpd_log('test/data/compressed/access.log.gz', format_type='common')
GROUP BY status
ORDER BY status;
----
200	2
201	1
304	1
403	1
404	1

# Test 3: Verify log_file metadata includes .gz extension
query T
SELECT replace(log_file, '\', '/') as log_file
FROM read_httpd_log('test/data/compressed/access.log.gz', format_type='common')
LIMIT 1;
----
test/data/compressed/access.log.gz

# Test 4: Verify method parsing from gzip file
query TI
SELECT method, COUNT(*) as count
FROM read_httpd_log('test/data/compressed/access.log.gz', format_type='common')
GROUP BY method
ORDER BY method;
----
GET	5
POST	1

# =============================================================================
# Test Group 2: Multiple gzip files with glob pattern
# =============================================================================

# Test 5: Read multiple gzip files - file count
query I
SELECT COUNT(DISTINCT log_file)
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common');
----
3

# Test 6: Read multiple gzip files - total row count
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common');
----
6

# Test 7: Verify row count per file
query TI
SELECT replace(log_file, '\', '/') as log_file, COUNT(*) as rows
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common')
GROUP BY log_file
ORDER BY replace(log_file, '\', '/');
----
test/data/compressed/server1.log.gz	2
test/data/compressed/server2.log.gz	2
test/data/compressed/server3.log.gz	2

# Test 8: Aggregate data across multiple gzip files
query I
SELECT SUM(bytes)
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common');
----
16896

# Test 9: Cross-file aggregation by status code
query II
SELECT status, COUNT(*) as count
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common')
GROUP BY status
ORDER BY status;
----
200	5
201	1

# Test 10: Cross-file aggregation by method
query TI
SELECT method, COUNT(*) as count
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common')
GROUP BY method
ORDER BY method;
----
GET	5
POST	1

# =============================================================================
# Test Group 3: Raw mode with gzip files
# =============================================================================

# Test 11: Raw mode with single gzip file
query II
SELECT
    COUNT(*) FILTER (WHERE parse_error = false) as valid,
    COUNT(*) FILTER (WHERE parse_error = true) as invalid
FROM read_httpd_log('test/data/compressed/access.log.gz', format_type='common', raw=true);
----
6	0

# Test 12: Raw mode with multiple gzip files
query II
SELECT
    COUNT(*) FILTER (WHERE parse_error = false) as valid,
    COUNT(*) FILTER (WHERE parse_error = true) as invalid
FROM read_httpd_log('test/data/compressed/server*.log.gz', format_type='common', raw=true);
----
6	0
