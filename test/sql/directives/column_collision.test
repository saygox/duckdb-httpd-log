# name: test/sql/directives/column_collision.test
# description: Test column name collision resolution for httpd_log extension
# group: [directives]

require httpd_log

# ============================================================================
# Test 1: %{Content-Length}i only - no suffix needed
# ============================================================================
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/header_collision.log',
        format_str='%h %l %u %t "%r" %>s %{Content-Length}i'
    )
)
WHERE column_name = 'content_length';
----
1

# ============================================================================
# Test 2: %{Content-Length}o only - no suffix needed
# ============================================================================
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/header_collision.log',
        format_str='%h %l %u %t "%r" %>s %{Content-Length}o'
    )
)
WHERE column_name = 'content_length';
----
1

# ============================================================================
# Test 3: Both %{Content-Length}i and %{Content-Length}o - suffixes applied
# ============================================================================
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'content_length_in') as has_in,
    COUNT(*) FILTER (WHERE column_name = 'content_length_out') as has_out
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/header_collision.log',
        format_str='%h %l %u %t "%r" %>s %{Content-Length}i %{Content-Length}o'
    )
);
----
1	1

# ============================================================================
# Test 4: Verify data is correctly parsed with collision resolution
# ============================================================================
query III
SELECT content_length_in, content_length_out, status
FROM read_httpd_log(
    'test/data/directives/header_collision.log',
    format_str='%h %l %u %t "%r" %>s %{Content-Length}i %{Content-Length}o'
)
ORDER BY client_ip;
----
1024	2048	200
0	512	201
0	0	304

# ============================================================================
# Test 5: Same header appearing multiple times - numbered
# ============================================================================
query III
SELECT
    COUNT(*) FILTER (WHERE column_name = 'x_custom') as first,
    COUNT(*) FILTER (WHERE column_name = 'x_custom_2') as second,
    COUNT(*) FILTER (WHERE column_name = 'x_custom_3') as third
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %b %{X-Custom}i %{X-Custom}i %{X-Custom}i'
    )
);
----
1	1	1

# ============================================================================
# Test 6: Mixed collision - same header in both %i and %o, plus duplicates
# ============================================================================
query III
SELECT
    COUNT(*) FILTER (WHERE column_name = 'x_mixed_in') as in_col,
    COUNT(*) FILTER (WHERE column_name = 'x_mixed_out') as out_col,
    COUNT(*) FILTER (WHERE column_name = 'x_mixed_in_2') as in_2_col
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %b %{X-Mixed}i %{X-Mixed}o %{X-Mixed}i'
    )
);
----
1	1	1

# ============================================================================
# Test 7: Existing %s/%>s resolution still works
# ============================================================================
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'status') as status_count,
    COUNT(*) FILTER (WHERE column_name = 'status_original') as original_count
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/status_both.log',
        format_str='%h %t "%r" %>s %b %s'
    )
);
----
1	1

# ============================================================================
# Test 8: Existing %b/%B resolution still works
# ============================================================================
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'bytes') as bytes_count,
    COUNT(*) FILTER (WHERE column_name = 'bytes_clf') as clf_count
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_both.log',
        format_str='%h %l %u %t "%r" %>s %B %b'
    )
);
----
1	1

# ============================================================================
# Test 9: Backward compatibility - single header no change
# ============================================================================
query II
SELECT column_name, column_type
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/combined/combined.log',
        format_str='%h %l %u %t "%r" %>s %b "%{Referer}i" "%{User-Agent}i"'
    )
)
WHERE column_name IN ('referer', 'user_agent')
ORDER BY column_name;
----
referer	VARCHAR
user_agent	VARCHAR

# ============================================================================
# Test 10: %v/%V resolution still works
# ============================================================================
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'server_name') as server_count,
    COUNT(*) FILTER (WHERE column_name = 'server_name_used') as used_count
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/server_both.log',
        format_str='%h %v %V %t "%r" %>s %b'
    )
);
----
1	1
