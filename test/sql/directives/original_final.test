# name: test/sql/directives/original_final.test
# description: Tests for < > modifiers (original/final request)
# group: [directives]

require httpd_log

# Test 1: %s alone → status (no suffix)
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'status')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %s %b'
));
----
1

# Test 2: %>s alone → status (no suffix)
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'status')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %>s %b'
));
----
1

# Test 3: %<s alone → status (no suffix)
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'status')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %<s %b'
));
----
1

# Test 4: %s + %>s → status (final) + status_original
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'status') as status_count,
    COUNT(*) FILTER (WHERE column_name = 'status_original') as status_original_count
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %s %>s %b'
));
----
1	1

# Test 5: %U alone → path (no suffix)
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'path')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %U %t'
));
----
1

# Test 6: %>U alone → path (no suffix)
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'path')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %>U %t'
));
----
1

# Test 7: %U + %>U → path (final) + path_original
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'path') as path_count,
    COUNT(*) FILTER (WHERE column_name = 'path_original') as path_original_count
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %U %>U %t'
));
----
1	1

# Test 8: %D alone → duration
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'duration')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %t %D'
));
----
1

# Test 9: %>D alone → duration
query I
SELECT COUNT(*) FILTER (WHERE column_name = 'duration')
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %t %>D'
));
----
1

# Test 10: %r alone → method, path, query_string, protocol
query I
SELECT COUNT(*) FILTER (WHERE column_name IN ('method', 'path', 'query_string', 'protocol'))
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %>s %b'
));
----
4

# Test 11: %>r alone → method, path, query_string, protocol
query I
SELECT COUNT(*) FILTER (WHERE column_name IN ('method', 'path', 'query_string', 'protocol'))
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%>r" %>s %b'
));
----
4

# Test 12: %<s behaves same as %s (explicit original)
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'status') as status_count,
    COUNT(*) FILTER (WHERE column_name = 'status_original') as status_original_count
FROM (DESCRIBE SELECT * FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %<s %>s %b'
));
----
1	1

# Test 13: Verify values are correctly parsed with %>s
query III
SELECT status, bytes, COUNT(*) as count
FROM read_httpd_log(
    'test/data/directives/original_final.log',
    format_str='%h %l %u %t "%r" %>s %b'
)
GROUP BY status, bytes
ORDER BY status;
----
200	2326	1
302	512	1
304	0	1

