# name: test/sql/directives/bytes_directives.test
# description: Tests for %b and %B directive handling (distinct columns when both present)
# group: [directives]

require httpd_log

# Test 1: %b only - uses column name "bytes"
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %b'
    )
)
WHERE column_name = 'bytes';
----
1

# Test 2: %B only - uses column name "bytes"
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %B'
    )
)
WHERE column_name = 'bytes';
----
1

# Test 3: Both %b and %B present - %b becomes "bytes_clf", %B becomes "bytes"
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'bytes_clf') as has_bytes_clf,
    COUNT(*) FILTER (WHERE column_name = 'bytes') as has_bytes
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %b %B'
    )
);
----
1	1

# Test 4: Verify data parsing with %b only - "-" becomes 0
query I
SELECT COUNT(*)
FROM read_httpd_log(
    'test/data/directives/bytes_with_dash.log',
    format_str='%h %l %u %t "%r" %>s %b'
)
WHERE bytes = 0;
----
2

# Test 5: Verify data parsing with %B only - "0" is 0 (not NULL)
query I
SELECT COUNT(*)
FROM read_httpd_log(
    'test/data/directives/bytes_with_zero.log',
    format_str='%h %l %u %t "%r" %>s %B'
)
WHERE bytes = 0;
----
2

# Test 6: Both %b and %B - verify same behavior (both convert "-" to 0)
query III
SELECT bytes_clf, bytes, client_ip
FROM read_httpd_log(
    'test/data/directives/bytes_b_and_B.log',
    format_str='%h %l %u %t "%r" %>s %b %B'
)
ORDER BY client_ip;
----
2326	2326	192.168.1.1
0	0	192.168.1.2
0	0	192.168.1.3

# Test 7: Verify %b with non-zero value
query I
SELECT bytes_clf
FROM read_httpd_log(
    'test/data/directives/bytes_b_and_B.log',
    format_str='%h %l %u %t "%r" %>s %b %B'
)
WHERE client_ip = '192.168.1.1';
----
2326

# Test 8: Verify %B always has numeric value (0 or actual bytes)
query I
SELECT bytes
FROM read_httpd_log(
    'test/data/directives/bytes_b_and_B.log',
    format_str='%h %l %u %t "%r" %>s %b %B'
)
WHERE client_ip = '192.168.1.2';
----
0

# Test 9: Verify both columns have BIGINT type
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'bytes_clf' AND column_type = 'BIGINT') as clf_is_bigint,
    COUNT(*) FILTER (WHERE column_name = 'bytes' AND column_type = 'BIGINT') as bytes_is_bigint
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %b %B'
    )
);
----
1	1

# Test 10: Reverse order (%B then %b) - column names should be the same
query II
SELECT
    COUNT(*) FILTER (WHERE column_name = 'bytes') as has_bytes,
    COUNT(*) FILTER (WHERE column_name = 'bytes_clf') as has_bytes_clf
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %B %b'
    )
);
----
1	1
