# name: test/sql/directives/bytes_directives.test
# description: Tests for %b and %B directive handling (equivalent, first occurrence wins)
# group: [directives]

require httpd_log

# Test 1: %b only - uses column name "bytes"
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %b'
    )
)
WHERE column_name = 'bytes';
----
1

# Test 2: %B only - uses column name "bytes"
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_str='%h %l %u %t "%r" %>s %B'
    )
)
WHERE column_name = 'bytes';
----
1

# Test 3: Both %b and %B present - only one "bytes" column (first wins, second skipped)
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %b %B'
    )
)
WHERE column_name = 'bytes';
----
1

# Test 4: Both %b and %B present - no bytes_clf column exists
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %b %B'
    )
)
WHERE column_name = 'bytes_clf';
----
0

# Test 5: Verify data parsing with %b only - "-" becomes 0
query I
SELECT COUNT(*)
FROM read_httpd_log(
    'test/data/directives/bytes_with_dash.log',
    format_str='%h %l %u %t "%r" %>s %b'
)
WHERE bytes = 0;
----
2

# Test 6: Verify data parsing with %B only - "0" is 0 (not NULL)
query I
SELECT COUNT(*)
FROM read_httpd_log(
    'test/data/directives/bytes_with_zero.log',
    format_str='%h %l %u %t "%r" %>s %B'
)
WHERE bytes = 0;
----
2

# Test 7: Both %b and %B - first occurrence value is used
query II
SELECT bytes, client_ip
FROM read_httpd_log(
    'test/data/directives/bytes_b_and_B.log',
    format_str='%h %l %u %t "%r" %>s %b %B'
)
ORDER BY client_ip;
----
2326	192.168.1.1
0	192.168.1.2
0	192.168.1.3

# Test 8: Verify %b with non-zero value
query I
SELECT bytes
FROM read_httpd_log(
    'test/data/directives/bytes_b_and_B.log',
    format_str='%h %l %u %t "%r" %>s %b %B'
)
WHERE client_ip = '192.168.1.1';
----
2326

# Test 9: Verify bytes has BIGINT type
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %b %B'
    )
)
WHERE column_name = 'bytes' AND column_type = 'BIGINT';
----
1

# Test 10: Reverse order (%B then %b) - still only one bytes column
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/bytes_b_and_B.log',
        format_str='%h %l %u %t "%r" %>s %B %b'
    )
)
WHERE column_name = 'bytes';
----
1
