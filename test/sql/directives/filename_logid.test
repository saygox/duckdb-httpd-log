# name: test/sql/directives/filename_logid.test
# description: Tests for filename (%f) and request log ID (%L) directives
# group: [directives]

require httpd_log

# =============================================================================
# Test Group 1: Column types
# =============================================================================

# Test 1: %f filename - column exists with VARCHAR type
query TT
SELECT column_name, column_type
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/filename_logid.log',
        format_str='%h %f %L'
    )
)
WHERE column_name = 'filename';
----
filename	VARCHAR

# Test 2: %L request_log_id - column exists with VARCHAR type
query TT
SELECT column_name, column_type
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/filename_logid.log',
        format_str='%h %f %L'
    )
)
WHERE column_name = 'request_log_id';
----
request_log_id	VARCHAR

# =============================================================================
# Test Group 2: Value extraction
# =============================================================================

# Test 3: Extract filename values
query T
SELECT filename
FROM read_httpd_log(
    'test/data/directives/filename_logid.log',
    format_str='%h %f %L'
)
ORDER BY filename;
----
/var/www/html/index.html
/var/www/html/script.js
/var/www/html/style.css

# Test 4: Extract request_log_id values
query T
SELECT request_log_id
FROM read_httpd_log(
    'test/data/directives/filename_logid.log',
    format_str='%h %f %L'
)
ORDER BY request_log_id;
----
-
abc123
def456

# =============================================================================
# Test Group 3: All columns together
# =============================================================================

# Test 5: All columns present - 4 columns total (client_ip, filename, request_log_id, log_file)
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/filename_logid.log',
        format_str='%h %f %L'
    )
);
----
4

# Test 6: Extract all values from first row
query TTT
SELECT client_ip, filename, request_log_id
FROM read_httpd_log(
    'test/data/directives/filename_logid.log',
    format_str='%h %f %L'
)
ORDER BY filename
LIMIT 1;
----
192.168.1.1	/var/www/html/index.html	abc123

# =============================================================================
# Test Group 4: log_file (auto column) is separate from filename (%f)
# =============================================================================

# Test 7: Both filename and log_file exist as separate columns
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/filename_logid.log',
        format_str='%h %f %L'
    )
)
WHERE column_name IN ('filename', 'log_file')
ORDER BY column_name;
----
filename
log_file

# Test 8: log_file contains the source log path, filename contains %f value
query TT
SELECT
    filename,
    replace(log_file, '\', '/') as log_file
FROM read_httpd_log(
    'test/data/directives/filename_logid.log',
    format_str='%h %f %L'
)
ORDER BY filename
LIMIT 1;
----
/var/www/html/index.html	test/data/directives/filename_logid.log

