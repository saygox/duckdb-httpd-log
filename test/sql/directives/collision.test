# name: test/sql/directives/collision.test
# description: Tests for VARNAME collision resolution across directive types
# group: [directives]

require httpd_log

# =============================================================================
# Test Group 1: Same VARNAME across multiple directive types
# All 7 modifier-based directives (%i, %o, %C, %e, %n, %^ti, %^to) with same name
# =============================================================================

# Test 1: %{foo}i (priority 1) gets base name, %{foo}o (priority 2) gets suffix
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{foo}i %{foo}o'
    )
)
WHERE column_name IN ('foo', 'foo_out');
----
2

# Test 2: %{foo}C (priority 3) gets base name, %{foo}e (priority 4) gets suffix
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{foo}C %{foo}e'
    )
)
WHERE column_name IN ('foo', 'foo_env');
----
2

# Test 3: %{foo}^ti (priority 6) gets base name, %{foo}^to (priority 7) gets suffix
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{foo}^ti %{foo}^to'
    )
)
WHERE column_name IN ('foo', 'foo_trail_out');
----
2

# Test 4: Three-way collision - %{foo}i (lowest priority) gets base, others get suffixes
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{foo}i %{foo}C %{foo}n'
    )
)
WHERE column_name IN ('foo', 'foo_cookie', 'foo_note');
----
3

# Test 5: All 7 modifier-based directives with same VARNAME
# %{x}i (priority 1) gets base name 'x', others get suffixes
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{x}C %{x}e %{x}n %{x}^ti %{x}^to %{x}i %{x}o'
    )
)
WHERE column_name LIKE 'x%';
----
7

# Test 6: Verify all 7 column names - %{x}i gets base name, others get suffixes
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{x}C %{x}e %{x}n %{x}^ti %{x}^to %{x}i %{x}o'
    )
)
WHERE column_name LIKE 'x%'
ORDER BY column_name;
----
x
x_cookie
x_env
x_note
x_out
x_trail_in
x_trail_out

# =============================================================================
# Test Group 2: VARNAME collision with existing directive column names
# Testing %{path}C vs %U, %{method}i vs %m, etc.
# =============================================================================

# Test 7: %{path}C collides with %U (which produces 'path')
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %U %{path}C'
    )
)
WHERE column_name IN ('path', 'path_cookie');
----
2

# Test 8: Verify %U keeps 'path' and %{path}C gets '_cookie' suffix
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %U %{path}C'
    )
)
WHERE column_name LIKE 'path%'
ORDER BY column_name;
----
path
path_cookie

# Test 9: %{method}i collides with %m (which produces 'method')
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %m %{method}i'
    )
)
WHERE column_name LIKE 'method%'
ORDER BY column_name;
----
method
method_in

# Test 10: %{status}e collides with %s (which produces 'status')
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %>s %{status}e'
    )
)
WHERE column_name LIKE 'status%'
ORDER BY column_name;
----
status
status_env

# Test 11: %{protocol}n collides with %H (which produces 'protocol')
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %H %{protocol}n'
    )
)
WHERE column_name LIKE 'protocol%'
ORDER BY column_name;
----
protocol
protocol_note

# Test 12: %{client_ip}C collides with %h (which produces 'client_ip')
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{client_ip}C'
    )
)
WHERE column_name LIKE 'client_ip%'
ORDER BY column_name;
----
client_ip
client_ip_cookie

# =============================================================================
# Test Group 3: Multiple collisions of same type (duplicate directives)
# =============================================================================

# Test 13: Same directive twice - %{foo}i %{foo}i -> foo, foo_2
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{foo}i %{foo}i'
    )
)
WHERE column_name LIKE 'foo%'
ORDER BY column_name;
----
foo
foo_2

# Test 14: Same directive three times - %{bar}C %{bar}C %{bar}C -> bar, bar_2, bar_3
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{bar}C %{bar}C %{bar}C'
    )
)
WHERE column_name LIKE 'bar%'
ORDER BY column_name;
----
bar
bar_2
bar_3

# =============================================================================
# Test Group 4: Hyphen to underscore conversion in VARNAME
# =============================================================================

# Test 15: Hyphenated VARNAME collision - %{X-Custom}i gets base, %{X-Custom}o gets suffix
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{X-Custom}i %{X-Custom}o'
    )
)
WHERE column_name LIKE 'x_custom%'
ORDER BY column_name;
----
x_custom
x_custom_out

# Test 16: Hyphenated VARNAME with cookie - %{my-session}C gets base, %{my-session}e gets suffix
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{my-session}C %{my-session}e'
    )
)
WHERE column_name LIKE 'my_session%'
ORDER BY column_name;
----
my_session
my_session_env

# =============================================================================
# Test Group 5: Case insensitivity (VARNAME normalized to lowercase)
# =============================================================================

# Test 17: Uppercase VARNAME collision - %{FOO}i gets base, %{foo}o gets suffix
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{FOO}i %{foo}o'
    )
)
WHERE column_name LIKE 'foo%'
ORDER BY column_name;
----
foo
foo_out

# Test 18: Mixed case collision - %{Content-Type}i gets base name, %{content-type}C gets suffix
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %{Content-Type}i %{content-type}C'
    )
)
WHERE column_name LIKE 'content_type%'
ORDER BY column_name;
----
content_type
content_type_cookie

# =============================================================================
# Test Group 6: Complex mixed collisions
# =============================================================================

# Test 19: %{path}i + %{path}o + %{path}C + %U (path)
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %U %{path}i %{path}o %{path}C'
    )
)
WHERE column_name LIKE 'path%'
ORDER BY column_name;
----
path
path_cookie
path_in
path_out

# Test 20: Verify column count with complex collision scenario
query I
SELECT COUNT(*)
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %U %{path}i %{path}o %{path}C'
    )
)
WHERE column_name LIKE 'path%';
----
4

# Test 21: All types collision with existing directive
query T
SELECT column_name
FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/directives/collision_test.log',
        format_str='%h %m %{method}C %{method}e %{method}n %{method}^ti %{method}^to %{method}i %{method}o'
    )
)
WHERE column_name LIKE 'method%'
ORDER BY column_name;
----
method
method_cookie
method_env
method_in
method_note
method_out
method_trail_in
method_trail_out

