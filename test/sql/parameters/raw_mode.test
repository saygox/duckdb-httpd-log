# name: test/sql/parameters/raw_mode.test
# description: Comprehensive tests for raw parameter behavior
# group: [parameters]

require httpd_log

# Test 1: raw=false skips parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log');
----
3

# Test 2: raw=true includes parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', raw=true);
----
5

# Test 3: parse_error column shows error distribution with raw=true
query II
SELECT
    parse_error,
    COUNT(*) as count
FROM read_httpd_log('test/data/common/with_errors.log', raw=true)
GROUP BY parse_error
ORDER BY parse_error;
----
0	3
1	2

# Test 4: parse_error column not accessible with raw=false
statement error
SELECT parse_error FROM read_httpd_log('test/data/common/with_errors.log');
----
Binder Error: Referenced column "parse_error" not found in FROM clause

# Test 5: raw_line populated for parse errors with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', raw=true)
WHERE parse_error = true AND raw_line IS NOT NULL AND LENGTH(raw_line) > 0;
----
2

# Test 6: raw_line is NULL for successful parses with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false AND raw_line IS NULL;
----
6

# Test 7: raw_line column not accessible with raw=false
statement error
SELECT raw_line FROM read_httpd_log('test/data/common/with_errors.log');
----
Binder Error: Referenced column "raw_line" not found in FROM clause

# Test 8: timestamp_raw populated with raw=true
query T
SELECT timestamp_raw
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false
ORDER BY timestamp
LIMIT 1;
----
10/Oct/2000:13:55:36 -0700

# Test 9: timestamp_raw column not accessible with raw=false
statement error
SELECT timestamp_raw FROM read_httpd_log('test/data/common/sample.log');
----
Binder Error: Referenced column "timestamp_raw" not found in FROM clause

# Test 10: All 13 columns accessible with raw=true
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        timestamp_raw,
        method,
        path,
        protocol,
        status,
        bytes,
        filename,
        parse_error,
        raw_line
    FROM read_httpd_log('test/data/common/sample.log', raw=true)
);
----
6

# Test 11: Only 10 columns accessible with raw=false
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        method,
        path,
        protocol,
        status,
        bytes,
        filename
    FROM read_httpd_log('test/data/common/sample.log')
);
----
6

# Test 12: timestamp_raw matches original format
query TT
SELECT timestamp::VARCHAR, timestamp_raw
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false
ORDER BY timestamp
LIMIT 1;
----
2000-10-10 20:55:36	10/Oct/2000:13:55:36 -0700

# Test 13: parse_error is always false for valid logs
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = true;
----
0

# Test 14: parse_error is true for malformed lines
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', raw=true)
WHERE parse_error = true;
----
3

# Test 15: raw_line contains original text for errors
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', raw=true)
WHERE parse_error = true AND raw_line LIKE '%malformed%';
----
1

# Test 16: Filtering by parse_error with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', raw=true)
WHERE parse_error = false;
----
2

# Test 17: raw mode works with glob patterns
query II
SELECT
    parse_error,
    COUNT(*) as count
FROM read_httpd_log('test/data/common/*.log', raw=true)
GROUP BY parse_error
ORDER BY parse_error;
----
0	9
1	2

# Test 18: raw=false total count vs raw=true with multiple files
query II
SELECT
    (SELECT COUNT(*) FROM read_httpd_log('test/data/common/*.log')) as without_raw,
    (SELECT COUNT(*) FROM read_httpd_log('test/data/common/*.log', raw=true)) as with_raw;
----
9	11

# Test 19: timestamp_raw preserved for all successful parses
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false AND timestamp_raw IS NOT NULL;
----
6

# Test 20: raw mode with format_type parameter
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/combined/combined.log', format_type='combined', raw=true);
----
6

# Test 21: Error accessing diagnostic columns together without raw
statement error
SELECT parse_error, raw_line, timestamp_raw FROM read_httpd_log('test/data/common/sample.log');
----
Binder Error: Referenced column "parse_error" not found in FROM clause

# Test 22: All diagnostic columns accessible together with raw=true
query III
SELECT
    parse_error::INTEGER,
    raw_line IS NULL as raw_null,
    timestamp_raw IS NOT NULL as ts_raw_exists
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false
LIMIT 1;
----
0	1	1

# Test 23: Empty file behavior with raw=true
query I
SELECT COUNT(*) FROM read_httpd_log('test/data/common/empty.log', raw=true);
----
0

# Test 24: raw_line length matches original for errors
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', raw=true)
WHERE parse_error = true AND LENGTH(raw_line) > 10;
----
3

# Test 25: Comparing raw vs non-raw counts across all test data
query II
SELECT
    (SELECT COUNT(*) FROM read_httpd_log('test/data/**/*.log')) as default_mode,
    (SELECT COUNT(*) FROM read_httpd_log('test/data/**/*.log', raw=true)) as raw_mode;
----
36	66
