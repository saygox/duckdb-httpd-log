# name: test/sql/parameters/raw_mode.test
# description: Comprehensive tests for raw parameter behavior
# group: [parameters]

require httpd_log

# Test 1: raw=false skips parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', format_type='common');
----
3

# Test 2: raw=true includes parse error rows
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', format_type='common', raw=true);
----
5

# Test 3: parse_error column shows error distribution with raw=true
query II
SELECT
    parse_error,
    COUNT(*) as count
FROM read_httpd_log('test/data/common/with_errors.log', format_type='common', raw=true)
GROUP BY parse_error
ORDER BY parse_error;
----
0	3
1	2

# Test 4: parse_error column not accessible with raw=false
statement error
SELECT parse_error FROM read_httpd_log('test/data/common/with_errors.log', format_type='common');
----
Binder Error: Referenced column "parse_error" not found in FROM clause

# Test 5: raw_line populated for parse errors with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/with_errors.log', format_type='common', raw=true)
WHERE parse_error = true AND raw_line IS NOT NULL AND LENGTH(raw_line) > 0;
----
2

# Test 6: raw_line is populated for successful parses with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
WHERE parse_error = false AND raw_line IS NOT NULL;
----
6

# Test 7: raw_line column not accessible with raw=false
statement error
SELECT raw_line FROM read_httpd_log('test/data/common/with_errors.log', format_type='common');
----
Binder Error: Referenced column "raw_line" not found in FROM clause

# Test 8: All 13 columns accessible with raw=true
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        method,
        path,
        query_string,
        protocol,
        status,
        bytes,
        log_file,
        parse_error,
        raw_line
    FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
);
----
6

# Test 9: Only 11 columns accessible with raw=false
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        method,
        path,
        query_string,
        protocol,
        status,
        bytes,
        log_file
    FROM read_httpd_log('test/data/common/sample.log', format_type='common')
);
----
6

# Test 10: parse_error is always false for valid logs
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
WHERE parse_error = true;
----
0

# Test 11: parse_error is true for malformed lines
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', format_type='common', raw=true)
WHERE parse_error = true;
----
3

# Test 12: raw_line contains original text for errors
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', format_type='common', raw=true)
WHERE parse_error = true AND raw_line LIKE '%malformed%';
----
1

# Test 13: Filtering by parse_error with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', format_type='common', raw=true)
WHERE parse_error = false;
----
2

# Test 14: raw mode works with glob patterns
query II
SELECT
    parse_error,
    COUNT(*) as count
FROM read_httpd_log('test/data/common/*.log', format_type='common', raw=true)
GROUP BY parse_error
ORDER BY parse_error;
----
0	9
1	2

# Test 15: raw=false total count vs raw=true with multiple files
query II
SELECT
    (SELECT COUNT(*) FROM read_httpd_log('test/data/common/*.log', format_type='common')) as without_raw,
    (SELECT COUNT(*) FROM read_httpd_log('test/data/common/*.log', format_type='common', raw=true)) as with_raw;
----
9	11

# Test 16: raw mode with format_type parameter
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/combined/combined.log', format_type='combined', raw=true);
----
6

# Test 17: Error accessing diagnostic columns without raw
statement error
SELECT parse_error, raw_line FROM read_httpd_log('test/data/common/sample.log');
----
Binder Error: Referenced column "parse_error" not found in FROM clause

# Test 18: All diagnostic columns accessible together with raw=true
query II
SELECT
    parse_error::INTEGER,
    raw_line IS NULL as raw_null
FROM read_httpd_log('test/data/common/sample.log', raw=true)
WHERE parse_error = false
LIMIT 1;
----
0	0

# Test 19: Empty file behavior with raw=true
query I
SELECT COUNT(*) FROM read_httpd_log('test/data/common/empty.log', format_type='common', raw=true);
----
0

# Test 20: raw_line length matches original for errors
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/edge_cases/malformed.log', format_type='common', raw=true)
WHERE parse_error = true AND LENGTH(raw_line) > 10;
----
3

# Test 21: Comparing raw vs non-raw counts across all test data (common format)
query II
SELECT
    (SELECT COUNT(*) FROM read_httpd_log('test/data/**/*.log', format_type='common')) as default_mode,
    (SELECT COUNT(*) FROM read_httpd_log('test/data/**/*.log', format_type='common', raw=true)) as raw_mode;
----
44	133

# =============================================================================
# Test Group: line_number column (raw mode only)
# =============================================================================

# Test 22: line_number column is accessible with raw=true
query I
SELECT COUNT(*)
FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
WHERE line_number IS NOT NULL;
----
6

# Test 23: line_number starts at 1 and increments
query II
SELECT line_number, client_ip
FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
ORDER BY line_number
LIMIT 3;
----
1	192.168.1.1
2	192.168.1.2
3	192.168.1.3

# Test 24: line_number column not accessible with raw=false
statement error
SELECT line_number FROM read_httpd_log('test/data/common/sample.log', format_type='common');
----
Binder Error: Referenced column "line_number" not found in FROM clause

# Test 25: line_number helps identify error rows
query III
SELECT line_number, parse_error::INTEGER, raw_line
FROM read_httpd_log('test/data/common/with_errors.log', format_type='common', raw=true)
WHERE parse_error = true
ORDER BY line_number;
----
2	1	This is an invalid log line
4	1	Another bad line without proper format

# Test 26: line_number is BIGINT type
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log(
        'test/data/common/sample.log',
        format_type='common',
        raw=true
    )
)
WHERE column_name = 'line_number' AND column_type = 'BIGINT';
----
1

# Test 27: line_number resets for each file in glob pattern
query III
SELECT replace(log_file, '\', '/') as log_file, MIN(line_number) as min_line, MAX(line_number) as max_line
FROM read_httpd_log('test/data/multi_file/server*.log', format_type='common', raw=true)
GROUP BY log_file
ORDER BY replace(log_file, '\', '/');
----
test/data/multi_file/server1.log	1	2
test/data/multi_file/server2.log	1	2
test/data/multi_file/server3.log	1	2

# Test 28: All 14 columns accessible with raw=true (including line_number)
query I
SELECT COUNT(*) FROM (
    SELECT
        client_ip,
        ident,
        auth_user,
        timestamp,
        method,
        path,
        query_string,
        protocol,
        status,
        bytes,
        log_file,
        line_number,
        parse_error,
        raw_line
    FROM read_httpd_log('test/data/common/sample.log', format_type='common', raw=true)
);
----
6
