# name: test/sql/core/schema_validation.test
# description: Schema validation tests for different parameter combinations
# group: [core]

require httpd_log

# Test 1: Default schema has 11 columns (raw=false)
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
);
----
11

# Test 2: Verify default schema has expected columns
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
)
WHERE column_name IN ('client_ip', 'timestamp', 'method', 'path', 'status', 'bytes', 'log_file');
----
7

# Test 3: Verify timestamp column has TIMESTAMP type
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
)
WHERE column_name = 'timestamp' AND column_type = 'TIMESTAMP';
----
1

# Test 4: Raw mode schema has 14 columns
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
);
----
14

# Test 5: Verify raw mode has diagnostic columns
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
)
WHERE column_name IN ('timestamp_raw', 'parse_error', 'raw_line');
----
3

# Test 6: Verify raw mode adds BOOLEAN type for parse_error
query TT
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
)
WHERE column_name = 'parse_error';
----
parse_error	BOOLEAN

# Test 7: Verify timestamp_raw is VARCHAR in raw mode
query TT
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
)
WHERE column_name = 'timestamp_raw';
----
timestamp_raw	VARCHAR

# Test 8: Verify raw_line is VARCHAR in raw mode
query TT
SELECT column_name, column_type FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
)
WHERE column_name = 'raw_line';
----
raw_line	VARCHAR

# Test 9: Format type parameter doesn't affect schema structure
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', format_type='common')
);
----
11

# Test 10: Combined format with raw mode has 16 columns (11 base + 2 combined + 3 raw)
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/combined/combined.log', format_type='combined', raw=true)
);
----
16

# Test 11: Verify timestamp column always exists
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
)
WHERE column_name = 'timestamp';
----
1

# Test 12: Verify log_file column always exists
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
)
WHERE column_name = 'log_file';
----
1

# Test 13: Verify diagnostic columns don't exist in default mode
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log')
)
WHERE column_name IN ('parse_error', 'raw_line', 'timestamp_raw');
----
0

# Test 14: Verify all diagnostic columns exist in raw mode
query I
SELECT COUNT(*) FROM (
    DESCRIBE SELECT * FROM read_httpd_log('test/data/common/sample.log', raw=true)
)
WHERE column_name IN ('parse_error', 'raw_line', 'timestamp_raw');
----
3
